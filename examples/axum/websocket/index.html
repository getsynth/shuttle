<!DOCTYPE html>
<html lang="en" class="bg-gray-600">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Websocket status page</title>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="flex justify-around items-center h-screen w-screen m-0 text-center">
        <div class="flex max-w-sm flex-col overflow-hidden rounded-lg transition blur">
            <div class="flex-shrink-0 bg-gray-800 text-slate-50 p-5">
                Current API status
            </div>
            <div id="is_ok" class="flex flex-1 flex-col justify-between p-6 bg-gray-500 text-xl font-bold uppercase"></div>
        </div>
        <div class="flex max-w-sm flex-col overflow-hidden rounded-lg transition blur">
            <div class="flex-shrink-0 bg-gray-800 text-slate-50 p-5">
                Last check time
            </div>
            <div id="datetime" class="flex flex-1 flex-col justify-between p-6 bg-gray-500 text-xl font-bold"> </div>
        </div>
        <div class="flex max-w-sm flex-col overflow-hidden rounded-lg transition blur">
            <div class="flex-shrink-0 bg-gray-800 text-slate-50 p-5">
                Clients watching
            </div>
            <div id="clients_count" class="flex flex-1 flex-col justify-between p-6 bg-gray-500 text-xl font-bold"></div>
        </div>

        <div class="absolute text-3xl text-orange-500 transition">
            <p>Connection not open!!</p>
            <a href="/" class="underline">Reload page</a>
        </div>

        <script type="text/javascript">
         const is_ok = document.querySelector("#is_ok");
         const datetime = document.querySelector("#datetime");
         const clients_count = document.querySelector("#clients_count");

         const websocket = new WebSocket("ws://127.0.0.1:3000/websocket");

         websocket.onopen = () => {
             console.log("connection opened");
             document.querySelectorAll("body > div.flex").forEach(e => e.classList.remove("blur"));
             document.querySelector("body > div.absolute").classList.add("opacity-0");
         }

         websocket.onclose = () => {
             console.log("connection closed");
             document.querySelectorAll("body > div.flex").forEach(e => e.classList.add("blur"));
             document.querySelector("body > div.absolute").classList.remove("opacity-0");
         }

         websocket.onmessage = (e) => {
             const response = JSON.parse(e.data);

             if (response.is_up) {
                 is_ok.textContent = "up";
                 is_ok.classList.add("text-green-600");
                 is_ok.classList.remove("text-rose-700");
             } else {
                 is_ok.textContent = "down";
                 is_ok.classList.add("text-rose-700");
                 is_ok.classList.remove("text-green-600");
             }

             datetime.textContent = new Date(response.datetime).toLocaleString();
             clients_count.textContent = response.clients_count;
         }
        </script>
    </body>
</html>
